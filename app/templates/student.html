<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Student Portal - AttendAI</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🎓 Student Portal</h1>
        <div class="user-info">
          <span id="userEmail">Student</span>
          <button onclick="logout()" class="logout-btn">Logout</button>
        </div>
      </div>

      <!-- Face Verification & Attendance Section -->
      <div class="attendance-section">
        <div class="section-header">
          <h2>🎯 Face Verification & Attendance</h2>
          <div class="section-status">
            <div id="faceStatus" class="status-indicator">
              <span class="status-dot inactive"></span>
              <span>Face Recognition: Not Active</span>
        </div>
          </div>
        </div>
        
        <div class="footer">
          <div class="footer-left">AttendAI • Student Portal</div>
          <div class="footer-right">
            <a href="/admin" class="footer-link">Admin</a>
            <a href="/health" class="footer-link">Health</a>
            <a href="/metrics" class="footer-link">Metrics</a>
          </div>
        </div>
        
        <div class="camera-container">
          <div class="camera-wrapper">
            <video id="camera" autoplay muted playsinline></video>
            <div class="camera-overlay">
              <div class="camera-placeholder" id="cameraPlaceholder">
                <div class="camera-icon">📹</div>
                <p>Camera will start automatically when session is active</p>
        </div>
        </div>
          </div>
        </div>

        <div class="verification-form">
          <div class="form-row">
            <div class="form-group">
              <label for="admissionNumber">📋 Admission Number</label>
              <input type="text" id="admissionNumber" placeholder="Enter your admission number" required />
              <div class="input-hint">Your unique student ID</div>
          </div>
            <div class="form-group">
              <label for="sessionCode">🔑 Session Code</label>
              <input type="text" id="sessionCode" placeholder="Enter session code" required />
              <div class="input-hint">Provided by your teacher</div>
        </div>
          </div>
          <div class="action-buttons">
            <button id="verifyBtn" class="primary-btn large-btn" disabled>
              <span class="btn-icon">✅</span>
              <span class="btn-text">Verify & Mark Attendance</span>
            </button>
            <div class="loading-spinner hidden" id="verifySpinner"></div>
          </div>
        </div>
        
        <div id="faceMsg" class="status-message"></div>
          </div>

      <!-- Attendance Statistics Section -->
      <div class="stats-section">
        <h2>📊 Attendance Statistics</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="totalSessions">12</div>
            <div class="stat-label">Total Sessions</div>
        </div>
          <div class="stat-card">
            <div class="stat-number" id="attendedSessions">10</div>
            <div class="stat-label">Attended</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="attendancePercentage">83%</div>
            <div class="stat-label">Attendance %</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="lastAttendance">Today</div>
            <div class="stat-label">Last Attendance</div>
          </div>
        </div>
        </div>

      <!-- AI Study Tools Section -->
      <div class="study-tools-section">
        <div class="section-header">
          <h2>🤖 AI Study Tools</h2>
          <p class="section-description">Upload your study materials and let AI create personalized learning content</p>
        </div>
        
        <!-- Quiz Generator -->
        <div class="tool-card">
          <div class="tool-header">
            <h3>🧠 Quiz Generator</h3>
            <div class="tool-status" id="quizStatus">
              <span class="status-dot inactive"></span>
              <span>Ready</span>
            </div>
          </div>
          
          <div class="file-upload-area">
            <div class="file-upload">
              <input type="file" id="quizPdfFile" accept=".pdf" />
              <label for="quizPdfFile" class="file-upload-label">
                <div class="upload-icon">📄</div>
                <div class="upload-text">
                  <strong>Choose PDF for Quiz</strong>
                  <span>Click to browse or drag & drop</span>
                </div>
              </label>
              <div id="quizFileName" class="file-name"></div>
            </div>
          </div>
          
          <div class="tool-options">
            <div class="options-row">
              <div class="form-group">
                <label for="quizNumQuestions">📝 Number of Questions</label>
                <div class="range-container">
                  <input type="range" id="quizNumQuestions" min="5" max="20" value="10" />
                  <span id="quizNumQuestionsValue" class="range-value">10</span>
                </div>
              </div>
              <div class="form-group">
                <label for="quizDifficulty">⚡ Difficulty Level</label>
                <select id="quizDifficulty" class="select-input">
                  <option value="easy">Easy</option>
                  <option value="moderate" selected>Moderate</option>
                  <option value="hard">Hard</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="tool-actions">
            <button id="generateQuizBtn" class="primary-btn" disabled>
              <span class="btn-icon">🚀</span>
              <span class="btn-text">Generate Quiz</span>
            </button>
            <div class="loading-spinner hidden" id="quizSpinner"></div>
          </div>
          
          <div id="quizContainer" class="quiz-container"></div>
        </div>

        <!-- Flashcards Generator -->
        <div class="tool-card">
          <div class="tool-header">
            <h3>🎴 Flashcards Generator</h3>
            <div class="tool-status" id="flashcardStatus">
              <span class="status-dot inactive"></span>
              <span>Ready</span>
            </div>
          </div>
          
          <div class="file-upload-area">
            <div class="file-upload">
              <input type="file" id="flashcardPdfFile" accept=".pdf" />
              <label for="flashcardPdfFile" class="file-upload-label">
                <div class="upload-icon">📄</div>
                <div class="upload-text">
                  <strong>Choose PDF for Flashcards</strong>
                  <span>Click to browse or drag & drop</span>
                </div>
              </label>
              <div id="flashcardFileName" class="file-name"></div>
            </div>
          </div>
          
          <div class="tool-options">
            <div class="options-row">
              <div class="form-group">
                <label for="cardsPerParagraph">📚 Cards per Paragraph</label>
                <div class="range-container">
                  <input type="range" id="cardsPerParagraph" min="1" max="25" value="12" />
                  <span id="cardsPerParagraphValue" class="range-value">12</span>
                </div>
              </div>
              <div class="form-group">
                <label for="fallbackCards">🎯 Total Cards</label>
                <div class="range-container">
                  <input type="range" id="fallbackCards" min="4" max="40" value="16" />
                  <span id="fallbackCardsValue" class="range-value">16</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="tool-actions">
            <button id="generateFlashcardsBtn" class="primary-btn" disabled>
              <span class="btn-icon">🚀</span>
              <span class="btn-text">Generate Flashcards</span>
            </button>
            <div class="loading-spinner hidden" id="flashcardSpinner"></div>
          </div>
          
          <div id="flashcardsContainer" class="flashcards-container"></div>
        </div>

        <!-- Study Timetable -->
        <div class="tool-card">
          <div class="tool-header">
            <h3>📅 Study Timetable Generator</h3>
            <div class="tool-status" id="timetableStatus">
              <span class="status-dot inactive"></span>
              <span>Ready</span>
            </div>
          </div>
          
          <div class="timetable-setup">
            <div class="form-row">
              <div class="form-group">
                <label for="subjects">📚 Subjects</label>
                <input type="text" id="subjects" placeholder="Math, Physics, Chemistry, Biology" />
                <div class="input-hint">Separate subjects with commas</div>
              </div>
              <div class="form-group">
                <label for="studyHours">⏰ Study Hours per Day</label>
                <div class="range-container">
                  <input type="range" id="studyHours" min="2" max="8" value="4" />
                  <span id="studyHoursValue" class="range-value">4 hours</span>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label for="difficultyLevels">⚡ Difficulty Levels</label>
              <input type="text" id="difficultyLevels" placeholder="hard, medium, easy, medium" />
              <div class="input-hint">Match the order of subjects (hard, medium, easy)</div>
            </div>
            
            <div class="tool-actions">
              <button id="generateTimetableBtn" class="primary-btn">
                <span class="btn-icon">📅</span>
                <span class="btn-text">Generate Timetable</span>
              </button>
              <div class="loading-spinner hidden" id="timetableSpinner"></div>
            </div>
            
            <div id="timetableContainer" class="timetable-container"></div>
          </div>
        </div>
          </div>
        </div>

    <div id="notification" class="notification hidden">
      <span id="notificationText"></span>
    </div>

    <script>
      // Camera and Face Verification
      async function startCamera() {
        try {
          const video = document.getElementById('camera');
          const overlay = document.querySelector('.camera-overlay');
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { 
              width: { ideal: 320 }, 
              height: { ideal: 240 }, 
              facingMode: 'user',
              frameRate: { ideal: 10, max: 15 }
            }
          });
          video.srcObject = stream;
          overlay.classList.add('hidden');
          document.getElementById("verifyBtn").disabled = false;
          document.getElementById("faceStatus").innerHTML = '<span class="status-dot active"></span><span>Face Recognition: Active</span>';
          showNotification("Camera started automatically", "success");
        } catch (error) {
          console.error("Error starting camera:", error);
          document.getElementById("faceStatus").innerHTML = '<span class="status-dot inactive"></span><span>Face Recognition: Camera access denied</span>';
          showNotification("Error starting camera. Please allow camera access.", "error");
        }
      }

      async function checkActiveSession() {
        try {
          const response = await fetch('/admin/sessions/active');
          if (response.ok) {
            const session = await response.json();
            if (session && session.is_active) {
              await startCamera();
              document.getElementById("sessionCode").value = session.code;
            }
          }
        } catch (error) {
          console.error("Error checking active session:", error);
        }
      }

      // Attendance Verification
      document.getElementById('verifyBtn').addEventListener('click', async function() {
        const admissionNumber = document.getElementById('admissionNumber').value;
        const sessionCode = document.getElementById('sessionCode').value;
        const verifyBtn = document.getElementById('verifyBtn');
        const spinner = document.getElementById('verifySpinner');

        if (!admissionNumber) {
          showNotification('Please enter your admission number', 'error');
          return;
        }

        if (!sessionCode) {
          showNotification('Please enter session code', 'error');
          return;
        }

        // Show loading state
        verifyBtn.disabled = true;
        verifyBtn.style.opacity = '0.5';
        spinner.classList.remove('hidden');

        try {
          const video = document.getElementById('camera');
        const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0);

          const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
          const formData = new FormData();
          formData.append('admission_number', admissionNumber);
          formData.append('code', sessionCode);
          formData.append('file', blob, 'face.jpg');

          const response = await fetch('/face/verify-by-admission', {
            method: 'POST',
            body: formData
          });

          const result = await response.json();
          if (!response.ok) {
            // If backend returned graceful message for no face, show info instead of error
            const detail = result && result.detail ? result.detail : (result && result.message ? result.message : 'Verification failed');
            if ((detail || '').toLowerCase().includes('no face')) {
              document.getElementById('faceMsg').textContent = `ℹ️ ${detail}. Please align your face in the frame and try again.`;
              document.getElementById('faceMsg').className = 'status-message';
              document.getElementById('faceMsg').style.display = 'block';
              showNotification(detail, 'info');
              return;
            }
            throw new Error(detail);
          }
          if (result && result.message && result.message.toLowerCase().includes('no face')) {
            document.getElementById('faceMsg').textContent = `ℹ️ ${result.message}. Please align your face in the frame and try again.`;
            document.getElementById('faceMsg').className = 'status-message';
            document.getElementById('faceMsg').style.display = 'block';
            showNotification(result.message, 'info');
            return;
          }
          document.getElementById('faceMsg').textContent = `✅ Verified! Similarity: ${(result.similarity || 0).toFixed(2)}`;
          document.getElementById('faceMsg').className = 'status-message success';
          document.getElementById('faceMsg').style.display = 'block';
          showNotification('🎉 Attendance marked successfully!', 'success');
          loadAttendanceStats();

          // If backend returned user_id, use it for WebSocket notifications and persist it
          if (result.user_id) {
            try {
              userId = String(result.user_id);
              localStorage.setItem('ATTENDAI_USER_ID', userId);
              // Reconnect WS with new user id
              try { ws && ws.close(); } catch (e) {}
              connectWebSocket();
            } catch (_) {}
          }
        } catch (error) {
          console.error("Error verifying attendance:", error);
          document.getElementById('faceMsg').textContent = `❌ Error: ${error.message}`;
          document.getElementById('faceMsg').className = 'status-message error';
          document.getElementById('faceMsg').style.display = 'block';
          showNotification("Error verifying attendance: " + error.message, "error");
        } finally {
          // Hide loading state
          verifyBtn.disabled = false;
          verifyBtn.style.opacity = '1';
          spinner.classList.add('hidden');
        }
      });

      // WebSocket connection for notifications
      let ws = null;
      let userId = '1'; // Default user ID for demo
      let reconnectAttempts = 0;
      const maxReconnectAttempts = 5;
      
      function connectWebSocket() {
        if (ws && ws.readyState === WebSocket.OPEN) return;
        
        try {
          const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
          const wsUrl = `${wsProto}://${location.host}/ws?user_id=${userId}`;
          ws = new WebSocket(wsUrl);
          
          ws.onopen = function() {
            console.log('WebSocket connected');
            reconnectAttempts = 0;
            document.getElementById('faceStatus').innerHTML = 
              '<span class="status-dot active"></span> Face Recognition: Connected';
          };
          
          ws.onmessage = function(event) {
            try {
              const data = JSON.parse(event.data);
              showNotification(data.message, 'success');
        } catch (e) {
              console.error('Error parsing WebSocket message:', e);
            }
          };
          
          ws.onclose = function() {
            console.log('WebSocket disconnected');
            document.getElementById('faceStatus').innerHTML = 
              '<span class="status-dot inactive"></span> Face Recognition: Disconnected';
            
            // Reconnect with exponential backoff
            if (reconnectAttempts < maxReconnectAttempts) {
              const delay = Math.pow(2, reconnectAttempts) * 1000; // 1s, 2s, 4s, 8s, 16s
              setTimeout(() => {
                reconnectAttempts++;
                connectWebSocket();
              }, delay);
            }
          };
          
          ws.onerror = function(error) {
            console.error('WebSocket error:', error);
            document.getElementById('faceStatus').innerHTML = 
              '<span class="status-dot inactive"></span> Face Recognition: Error';
          };
        } catch (error) {
          console.error('WebSocket connection failed:', error);
        }
      }

      // Load Attendance Statistics
      async function loadAttendanceStats() {
        try {
          // For demo purposes, using user ID 1 - in real app, this would be the logged-in user's ID
          const response = await fetch('/admin/attendance/stats/1');
          if (response.ok) {
            const stats = await response.json();
            document.getElementById('totalSessions').textContent = stats.total_sessions;
            document.getElementById('attendedSessions').textContent = stats.attended_sessions;
            document.getElementById('attendancePercentage').textContent = stats.attendance_percentage;
            document.getElementById('lastAttendance').textContent = stats.last_attendance;
          } else {
            // Fallback to placeholder data if API fails
            document.getElementById('totalSessions').textContent = '12';
            document.getElementById('attendedSessions').textContent = '10';
            document.getElementById('attendancePercentage').textContent = '83%';
            document.getElementById('lastAttendance').textContent = 'Today';
          }
        } catch (error) {
          console.error("Error loading attendance stats:", error);
          // Fallback to placeholder data
          document.getElementById('totalSessions').textContent = '12';
          document.getElementById('attendedSessions').textContent = '10';
          document.getElementById('attendancePercentage').textContent = '83%';
          document.getElementById('lastAttendance').textContent = 'Today';
        }
      }

      // Quiz Generator
      document.getElementById('quizPdfFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          document.getElementById('quizFileName').textContent = file.name;
          document.getElementById('generateQuizBtn').disabled = false;
        } else {
          document.getElementById('quizFileName').textContent = '';
          document.getElementById('generateQuizBtn').disabled = true;
        }
      });

      document.getElementById('quizNumQuestions').addEventListener('input', function() {
        document.getElementById('quizNumQuestionsValue').textContent = this.value;
      });

      document.getElementById('generateQuizBtn').addEventListener('click', async function() {
        const file = document.getElementById('quizPdfFile').files[0];
        if (!file) {
          showNotification('Please select a PDF file', 'error');
          return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('num_questions', document.getElementById('quizNumQuestions').value);
        formData.append('difficulty', document.getElementById('quizDifficulty').value);

        const btn = document.getElementById('generateQuizBtn');
        const spinner = document.getElementById('quizSpinner');
        const container = document.getElementById('quizContainer');
        // UI loading state
        btn.disabled = true; btn.style.opacity = '0.6'; spinner.classList.remove('hidden');
        container.classList.add('show');
        container.innerHTML = '<p>Generating quiz…</p>';

        try {
          const response = await fetch('/api/advanced/pdf/generate-quiz', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            // Deduplicate by prompt text if any duplicates slipped through
            const seen = new Set();
            const unique = [];
            for (const q of data.questions || []) {
              const key = (q.prompt || '').trim().toLowerCase();
              if (!key || seen.has(key)) continue;
              seen.add(key);
              unique.push(q);
            }
            displayQuiz(unique);
            showNotification(`Generated ${data.questions.length} questions!`, 'success');
          } else {
            showNotification('Error: ' + data.detail, 'error');
            container.innerHTML = `<p style="color:#ef4444">${data.detail || 'Failed to generate quiz'}</p>`;
          }
        } catch (error) {
          showNotification('Error: ' + error.message, 'error');
          container.innerHTML = `<p style="color:#ef4444">${error.message}</p>`;
        } finally {
          btn.disabled = false; btn.style.opacity = '1'; spinner.classList.add('hidden');
        }
      });

          function displayQuiz(questions) {
            const container = document.getElementById('quizContainer');
            
            if (questions.length === 0) {
              container.innerHTML = '<p>No questions generated. Try adjusting the parameters.</p>';
              container.classList.add('show');
              return;
            }

            container.innerHTML = questions.map((question, index) => `
              <div class="question-card">
                <h4>Question ${index + 1}</h4>
                <p class="question-text">${question.prompt}</p>
                <div class="options">
                  ${question.options.map((option, optionIndex) => `
                    <label class="option">
                      <input type="radio" name="question_${index}" value="${optionIndex}" data-correct="${question.correct_answer}">
                      <span class="option-text">${option}</span>
                    </label>
                  `).join('')}
                </div>
                <div class="answer-section" style="display: none;">
                  <strong>Correct Answer:</strong> ${question.options[question.correct_answer]}
                </div>
                <button class="check-answer-btn" onclick="toggleAnswer(${index})">Check Answer</button>
              </div>
            `).join('');
            
            // Show the container
            container.classList.add('show');
          }

      function toggleAnswer(questionIndex) {
        const questionCard = document.querySelector(`input[name="question_${questionIndex}"]`).closest('.question-card');
        const answerSection = questionCard.querySelector('.answer-section');
        const button = questionCard.querySelector('.check-answer-btn');
        const selectedOption = questionCard.querySelector(`input[name="question_${questionIndex}"]:checked`);
        
        // Check if an answer is selected
        if (!selectedOption) {
          showNotification('Please select an answer first!', 'error');
          return;
        }
        
        const selectedIndex = parseInt(selectedOption.value);
        const correctIndex = parseInt(selectedOption.getAttribute('data-correct'));
        
        // Get all options for this question
        const options = questionCard.querySelectorAll(`input[name="question_${questionIndex}"]`);
        
        // Reset all option styles
        options.forEach(option => {
          const optionElement = option.closest('.option');
          optionElement.classList.remove('correct', 'incorrect');
        });
        
        // Mark correct answer
        const correctOption = questionCard.querySelector(`input[name="question_${questionIndex}"][value="${correctIndex}"]`);
        const correctOptionElement = correctOption.closest('.option');
        correctOptionElement.classList.add('correct');
        
        // Mark selected answer if it's wrong
        if (selectedIndex !== correctIndex) {
          const selectedOptionElement = selectedOption.closest('.option');
          selectedOptionElement.classList.add('incorrect');
          showNotification('❌ Wrong answer! The correct answer is highlighted in green.', 'error');
        } else {
          showNotification('✅ Correct answer! Well done!', 'success');
        }
        
        // Show the answer section
        answerSection.style.display = 'block';
        button.textContent = 'Hide Answer';
        button.onclick = () => hideAnswer(questionIndex);
      }
      
      function hideAnswer(questionIndex) {
        const questionCard = document.querySelector(`input[name="question_${questionIndex}"]`).closest('.question-card');
        const answerSection = questionCard.querySelector('.answer-section');
        const button = questionCard.querySelector('.check-answer-btn');
        
        answerSection.style.display = 'none';
        button.textContent = 'Check Answer';
        button.onclick = () => toggleAnswer(questionIndex);
        
        // Reset option styles
        const options = questionCard.querySelectorAll(`input[name="question_${questionIndex}"]`);
        options.forEach(option => {
          const optionElement = option.closest('.option');
          optionElement.classList.remove('correct', 'incorrect');
        });
      }

      // Flashcards Generator
      document.getElementById('flashcardPdfFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          document.getElementById('flashcardFileName').textContent = file.name;
          document.getElementById('generateFlashcardsBtn').disabled = false;
        } else {
          document.getElementById('flashcardFileName').textContent = '';
          document.getElementById('generateFlashcardsBtn').disabled = true;
        }
      });

      document.getElementById('cardsPerParagraph').addEventListener('input', function() {
        document.getElementById('cardsPerParagraphValue').textContent = this.value;
      });

      document.getElementById('fallbackCards').addEventListener('input', function() {
        document.getElementById('fallbackCardsValue').textContent = this.value;
      });

      document.getElementById('generateFlashcardsBtn').addEventListener('click', async function() {
        const file = document.getElementById('flashcardPdfFile').files[0];
        if (!file) {
          showNotification('Please select a PDF file', 'error');
          return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('cards_per_paragraph', document.getElementById('cardsPerParagraph').value);
        formData.append('fallback_cards_total', document.getElementById('fallbackCards').value);
        formData.append('explain_min', '25');
        formData.append('explain_max', '55');

        try {
          // UI loading state
          const btn = document.getElementById('generateFlashcardsBtn');
          const spinner = document.getElementById('flashcardSpinner');
          btn.disabled = true; btn.style.opacity = '0.6'; spinner.classList.remove('hidden');

          const response = await fetch('/api/advanced/pdf/generate-flashcards', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            displayFlashcards(data.cards);
            showNotification(`Generated ${data.total_cards} flashcards!`, 'success');
          } else {
            showNotification('Error: ' + data.detail, 'error');
          }
        } catch (error) {
          showNotification('Error: ' + error.message, 'error');
        } finally {
          const btn = document.getElementById('generateFlashcardsBtn');
          const spinner = document.getElementById('flashcardSpinner');
          btn.disabled = false; btn.style.opacity = '1'; spinner.classList.add('hidden');
        }
      });

      function displayFlashcards(cards) {
        const container = document.getElementById('flashcardsContainer');
        container.innerHTML = '';

        if (cards.length === 0) {
          container.innerHTML = '<p>No flashcards generated. Try adjusting the parameters.</p>';
          container.classList.add('show');
          return;
        }

        // Deduplicate by question/front text
        const seenFront = new Set();
        const filtered = [];
        for (const c of cards) {
          const front = (c.front || c.summary || '').trim().toLowerCase();
          if (!front || seenFront.has(front)) continue;
          seenFront.add(front);
          filtered.push(c);
        }

        filtered.forEach((card, index) => {
          const cardElement = document.createElement('div');
          cardElement.className = 'flashcard';
          cardElement.innerHTML = `
            <div class="flashcard-header">
              <h4>Card ${index + 1}</h4>
              ${card.paragraph ? `<span class="paragraph-badge">Paragraph ${card.paragraph}</span>` : ''}
            </div>
            <div class="flashcard-content">
              <div class="flashcard-question">
                <strong>Question:</strong> ${card.front || card.summary}
              </div>
              <div class="flashcard-answer">
                <strong>Answer:</strong> ${card.back || card.explanation}
              </div>
            </div>
          `;
          container.appendChild(cardElement);
        });
        
        // Show the container
        container.classList.add('show');
      }

      // Timetable Generator
      document.getElementById('studyHours').addEventListener('input', function() {
        document.getElementById('studyHoursValue').textContent = this.value;
      });

      document.getElementById('generateTimetableBtn').addEventListener('click', async function() {
        const subjects = document.getElementById('subjects').value.split(',').map(s => s.trim());
        let difficultyLevels = document.getElementById('difficultyLevels').value.split(',').map(s => s.trim());
        const studyHours = parseInt(document.getElementById('studyHours').value);

        if (subjects.length === 0 || subjects[0] === '') {
          showNotification('Please enter subjects', 'error');
          return;
        }

        // Normalize difficulty levels to match subjects length
        const norm = (s) => (s || '').toLowerCase().trim();
        difficultyLevels = difficultyLevels.filter(Boolean).map(norm);
        const allowed = new Set(['easy','medium','hard']);
        while (difficultyLevels.length < subjects.length) difficultyLevels.push('medium');
        difficultyLevels = difficultyLevels.slice(0, subjects.length).map(x => allowed.has(x) ? x : 'medium');

        const btn = document.getElementById('generateTimetableBtn');
        const spinner = document.getElementById('timetableSpinner');
        const container = document.getElementById('timetableContainer');
        btn.disabled = true; btn.style.opacity = '0.6'; spinner.classList.remove('hidden');
        container.classList.add('show');
        container.innerHTML = '<p>Generating timetable…</p>';

        try {
          const response = await fetch('/api/advanced/timetable/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              subjects: subjects,
              difficulty_levels: difficultyLevels,
              study_hours_per_day: studyHours
            })
          });

          const data = await response.json();

          if (data.success) {
            displayTimetable(data.schedule);
            showNotification('Timetable generated successfully!', 'success');
          } else {
            const detail = data.detail || 'Unknown error generating timetable';
            showNotification('Error: ' + detail, 'error');
            const container = document.getElementById('timetableContainer');
            container.innerHTML = `<p style="color:#ef4444">${detail}</p>`;
            container.classList.add('show');
          }
        } catch (error) {
          showNotification('Error: ' + error.message, 'error');
          container.innerHTML = `<p style=\"color:#ef4444\">${error.message}</p>`;
        } finally {
          btn.disabled = false; btn.style.opacity = '1'; spinner.classList.add('hidden');
        }
      });

      function displayTimetable(schedule) {
        const container = document.getElementById('timetableContainer');
        
        if (!schedule || schedule.length === 0) {
          container.innerHTML = '<p>No timetable generated.</p>';
          container.classList.add('show');
          return;
        }

        container.innerHTML = `
          <div class="timetable">
            <h4>Your Study Schedule</h4>
            <div class="schedule-grid">
              ${schedule.map((item, index) => `
                <div class="schedule-item">
                  <div class="time-slot">${item.start_time} - ${item.end_time}</div>
                  <div class="subject">${item.subject}</div>
                  <div class="difficulty">${item.difficulty}</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
        
        // Show the container
        container.classList.add('show');
      }

      function logout() {
        window.location.href = '/login';
      }

      function showNotification(message, type) {
        const notification = document.getElementById('notification');
        const text = document.getElementById('notificationText');
        
        text.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'block';
        
        setTimeout(() => {
          notification.style.display = 'none';
        }, 3000);
      }

      // Range slider updates
      document.getElementById('quizNumQuestions').addEventListener('input', function() {
        document.getElementById('quizNumQuestionsValue').textContent = this.value;
      });
      
      document.getElementById('cardsPerParagraph').addEventListener('input', function() {
        document.getElementById('cardsPerParagraphValue').textContent = this.value;
      });
      
      document.getElementById('fallbackCards').addEventListener('input', function() {
        document.getElementById('fallbackCardsValue').textContent = this.value;
      });
      
      document.getElementById('studyHours').addEventListener('input', function() {
        document.getElementById('studyHoursValue').textContent = this.value + ' hours';
      });

      // File upload handlers
      document.getElementById('quizPdfFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          document.getElementById('quizFileName').textContent = file.name;
          document.getElementById('quizFileName').classList.add('show');
          document.getElementById('generateQuizBtn').disabled = false;
          document.getElementById('quizStatus').innerHTML = '<span class="status-dot active"></span><span>File Ready</span>';
        }
      });

      document.getElementById('flashcardPdfFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          document.getElementById('flashcardFileName').textContent = file.name;
          document.getElementById('flashcardFileName').classList.add('show');
          document.getElementById('generateFlashcardsBtn').disabled = false;
          document.getElementById('flashcardStatus').innerHTML = '<span class="status-dot active"></span><span>File Ready</span>';
        }
      });

      // Initialize
      try {
        const savedId = localStorage.getItem('ATTENDAI_USER_ID');
        if (savedId) userId = savedId;
      } catch (_) {}
      checkActiveSession();
      connectWebSocket(); // Initialize WebSocket connection
    </script>

    <style>
      /* Enhanced Student Page Styles */
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border);
      }
      
      .section-header h2 {
        margin: 0;
        color: var(--text);
        font-size: 1.5rem;
        font-weight: 600;
      }
      
      .section-description {
        color: var(--muted);
        font-size: 0.9rem;
        margin: 5px 0 0 0;
      }
      
      .section-status {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 20px;
        font-size: 0.85rem;
      }
      
      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
      }
      
      .status-dot.active {
        background: #10b981;
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
      }
      
      .status-dot.inactive {
        background: #6b7280;
      }
      
      .attendance-section {
        background: var(--panel-2);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      
      .camera-container {
        margin: 20px 0;
        position: relative;
      }
      
      .camera-wrapper {
        position: relative;
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
        border-radius: 12px;
        overflow: hidden;
        background: var(--panel);
        border: 2px solid var(--border);
      }
      
      .camera-wrapper video {
        width: 100%;
        height: auto;
        display: block;
      }
      
      .camera-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.8);
        transition: opacity 0.3s ease;
      }
      
      .camera-overlay.hidden {
        opacity: 0;
        pointer-events: none;
      }
      
      .camera-placeholder {
        text-align: center;
        color: white;
        padding: 20px;
      }
      
      .camera-icon {
        font-size: 3rem;
        margin-bottom: 10px;
      }
      
      .camera-placeholder p {
        margin: 0;
        font-size: 0.9rem;
        opacity: 0.8;
      }
      
      .verification-form {
        margin-top: 25px;
      }
      
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }
      
      .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .form-group label {
        font-weight: 600;
        color: var(--text);
        font-size: 0.9rem;
      }
      
      .form-group input {
        padding: 12px 16px;
        border: 2px solid var(--border);
        border-radius: 8px;
        background: var(--panel);
        color: var(--text);
        font-size: 1rem;
        transition: all 0.2s ease;
      }
      
      .form-group input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .input-hint {
        font-size: 0.8rem;
        color: var(--muted);
        margin-top: 4px;
      }
      
      .action-buttons {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-top: 20px;
      }
      
      .primary-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .primary-btn:hover:not(:disabled) {
        background: var(--primary-2);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }
      
      .primary-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      
      .large-btn {
        padding: 16px 32px;
        font-size: 1.1rem;
      }
      
      .btn-icon {
        font-size: 1.2rem;
      }
      
      .btn-text {
        font-weight: 600;
      }
      
      .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid var(--border);
        border-top: 2px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      .loading-spinner.hidden {
        display: none;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .status-message {
        margin-top: 15px;
        padding: 12px 16px;
        border-radius: 8px;
        font-weight: 500;
        text-align: center;
        display: none;
      }
      
      .status-message.success {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.2);
      }
      
      .status-message.error {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
      }
      
      .study-tools-section {
        margin-top: 40px;
      }
      
      .tool-card {
        background: var(--panel-2);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      
      .tool-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border);
      }
      
      .tool-header h3 {
        margin: 0;
        color: var(--text);
        font-size: 1.3rem;
        font-weight: 600;
      }
      
      .tool-status {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 15px;
        font-size: 0.8rem;
      }
      
      .file-upload-area {
        margin-bottom: 20px;
      }
      
      .file-upload {
        position: relative;
        display: inline-block;
        width: 100%;
      }
      
      .file-upload input[type="file"] {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }
      
      .file-upload-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        border: 2px dashed var(--border);
        border-radius: 12px;
        background: var(--panel);
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
      }
      
      .file-upload-label:hover {
        border-color: var(--primary);
        background: rgba(59, 130, 246, 0.05);
      }
      
      .upload-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
        opacity: 0.7;
      }
      
      .upload-text strong {
        display: block;
        margin-bottom: 5px;
        color: var(--text);
        font-size: 1.1rem;
      }
      
      .upload-text span {
        color: var(--muted);
        font-size: 0.9rem;
      }
      
      .file-name {
        margin-top: 10px;
        padding: 8px 12px;
        background: var(--accent);
        color: white;
        border-radius: 6px;
        font-size: 0.9rem;
        display: none;
      }
      
      .file-name.show {
        display: block;
      }
      
      .tool-options {
        margin-bottom: 20px;
      }
      
      .options-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      
      .range-container {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .range-container input[type="range"] {
        flex: 1;
        height: 6px;
        background: var(--border);
        border-radius: 3px;
        outline: none;
        -webkit-appearance: none;
      }
      
      .range-container input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        background: var(--primary);
        border-radius: 50%;
        cursor: pointer;
      }
      
      .range-value {
        min-width: 40px;
        text-align: center;
        font-weight: 600;
        color: var(--text);
        background: var(--panel);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9rem;
      }
      
      .select-input {
        padding: 10px 12px;
        border: 2px solid var(--border);
        border-radius: 8px;
        background: var(--panel);
        color: var(--text);
        font-size: 1rem;
        cursor: pointer;
      }
      
      .select-input:focus {
        outline: none;
        border-color: var(--primary);
      }
      
      .tool-actions {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
      }
      
      .quiz-container, .flashcards-container, .timetable-container {
        margin-top: 20px;
        padding: 20px;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        display: none;
      }
      
      .quiz-container.show, .flashcards-container.show, .timetable-container.show {
        display: block;
      }
      
      /* Quiz Styles */
      .question-card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .question-text {
        font-size: 1.1rem;
        margin-bottom: 15px;
        color: var(--text);
      }
      
      .options {
        margin-bottom: 15px;
      }
      
      .option {
        display: block;
        margin-bottom: 8px;
        cursor: pointer;
      }
      
      .option input[type="radio"] {
        margin-right: 8px;
      }
      
      .option-text {
        color: var(--text);
      }
      
      .option.correct {
        background: rgba(16, 185, 129, 0.1);
        border: 2px solid #10b981;
        border-radius: 6px;
        padding: 8px;
      }
      
      .option.correct .option-text {
        color: #10b981;
        font-weight: 600;
      }
      
      .option.incorrect {
        background: rgba(239, 68, 68, 0.1);
        border: 2px solid #ef4444;
        border-radius: 6px;
        padding: 8px;
      }
      
      .option.incorrect .option-text {
        color: #ef4444;
        font-weight: 600;
      }
      
      .check-answer-btn {
        background: var(--accent);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
      }
      
      .check-answer-btn:hover {
        background: var(--primary);
      }
      
      .answer-section {
        margin-top: 15px;
        padding: 10px;
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.2);
        border-radius: 6px;
        color: #10b981;
      }
      
      /* Flashcard Styles */
      .flashcard {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      
      .flashcard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border);
      }
      
      .paragraph-badge {
        background: var(--accent);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
      }
      
      .flashcard-question {
        margin-bottom: 15px;
        padding: 15px;
        background: rgba(59, 130, 246, 0.1);
        border-radius: 6px;
        border-left: 4px solid var(--primary);
      }
      
      .flashcard-answer {
        padding: 15px;
        background: rgba(16, 185, 129, 0.1);
        border-radius: 6px;
        border-left: 4px solid #10b981;
      }
      
      /* Timetable Styles */
      .timetable h4 {
        margin-bottom: 20px;
        color: var(--text);
        text-align: center;
      }
      
      .schedule-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
      }
      
      .schedule-item {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 15px;
        text-align: center;
      }
      
      .time-slot {
        font-weight: 600;
        color: var(--primary);
        margin-bottom: 8px;
      }
      
      .subject {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 5px;
      }
      
      .difficulty {
        font-size: 0.9rem;
        color: var(--muted);
        text-transform: capitalize;
      }

      .stats-section {
        background: var(--panel-2);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 25px;
        margin-bottom: 20px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .stat-card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 20px;
        text-align: center;
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: var(--primary);
        margin-bottom: 5px;
      }

      .stat-label {
        color: var(--muted);
        font-size: 0.9em;
      }

      .study-tools-section {
        background: var(--panel-2);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 25px;
        margin-bottom: 20px;
      }

      .tool-card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 20px;
        margin-bottom: 20px;
      }

      .file-upload {
        margin: 15px 0;
      }

      .file-upload input[type="file"] {
        display: none;
      }

      .file-upload-label {
        display: inline-block;
        padding: 10px 20px;
        background: var(--primary);
        color: white;
        border-radius: var(--radius);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .file-upload-label:hover {
        background: var(--primary-2);
      }

      .file-name {
        margin-left: 10px;
        color: var(--muted);
      }

      .quiz-options, .flashcard-options, .timetable-setup {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 15px 0;
        padding: 15px;
        background: var(--panel-2);
        border-radius: var(--radius);
        border: 1px solid var(--border);
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .form-group input[type="range"] {
        width: 100%;
      }

      .form-group select, .form-group input[type="text"] {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--panel);
        color: var(--text);
      }

      .quiz-container, .flashcards-container, .timetable-container {
        margin-top: 20px;
      }

      .question-card {
        background: var(--panel-2);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 20px;
        margin-bottom: 15px;
      }

      .question-text {
        font-size: 16px;
        margin: 10px 0;
        line-height: 1.6;
      }

      .options {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin: 15px 0;
      }

      .option {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .option:hover {
        border-color: var(--primary);
        background: var(--panel-2);
      }

      .option input[type="radio"] {
        margin-right: 10px;
      }

      .answer-section {
        background: var(--accent);
        color: white;
        padding: 12px;
        border-radius: 8px;
        margin: 10px 0;
      }

      .check-answer-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .check-answer-btn:hover {
        background: var(--primary-2);
      }

      .flashcard {
        background: var(--panel-2);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 20px;
        margin-bottom: 15px;
      }

      .flashcard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border);
      }

      .paragraph-badge {
        background: var(--accent);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
      }

      .flashcard-question {
        margin-bottom: 15px;
        font-weight: 500;
      }

      .flashcard-answer {
        color: var(--muted);
        line-height: 1.6;
      }

      .timetable {
        margin-top: 20px;
      }

      .schedule-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }

      .schedule-item {
        background: var(--panel-2);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 15px;
      }

      .time-slot {
        font-weight: bold;
        color: var(--primary);
        margin-bottom: 5px;
      }

      .subject {
        font-size: 16px;
        margin-bottom: 5px;
      }

      .difficulty {
        font-size: 12px;
        color: var(--muted);
        text-transform: uppercase;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: var(--radius);
        color: white;
        z-index: 1000;
        display: none;
      }

      .notification.success {
        background: var(--accent);
      }

      .notification.error {
        background: var(--danger);
      }

      .notification.info {
        background: var(--primary);
      }

      @media (max-width: 768px) {
        .verification-form {
          grid-template-columns: 1fr;
        }
        
        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      /* Footer */
      .footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid var(--border);
        color: var(--muted);
        font-size: 0.9rem;
      }

      .footer-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .footer-link {
        color: var(--muted);
        text-decoration: none;
        padding: 6px 10px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--panel);
        transition: all 0.2s ease;
      }

      .footer-link:hover {
        color: var(--text);
        background: var(--primary);
        border-color: var(--primary-2);
      }
    </style>
  </body>
</html>
