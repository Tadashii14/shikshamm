<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Auto Quiz from PDF (Moderate Difficulty)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: light dark;
      --bg: #0b0c0f;
      --panel: #111318;
      --panel-2: #151922;
      --text: #e9ecf1;
      --muted: #a9b1bd;
      --primary: #4c8bf5;
      --primary-2: #2f74f0;
      --accent: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
      --border: #273043;
      --shadow: 0 10px 24px rgba(0,0,0,.35);
      --radius: 12px;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f6f7fb;
        --panel: #ffffff;
        --panel-2: #f8fafc;
        --text: #0e1116;
        --muted: #495467;
        --primary: #2563eb;
        --primary-2: #1d4ed8;
        --accent: #16a34a;
        --danger: #dc2626;
        --warning: #d97706;
        --border: #e5e7eb;
        --shadow: 0 10px 24px rgba(16, 24, 40, .08);
      }
    }
    * { box-sizing: border-box; }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      margin: 0;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 110% -10%, rgba(76,139,245,.15), transparent 40%),
        radial-gradient(900px 500px at -10% -10%, rgba(34,197,94,.12), transparent 45%),
        var(--bg);
      min-height: 100dvh;
    }
    .wrap { max-width: 920px; margin: 36px auto; padding: 0 20px 24px; }
    .header {
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
    }
    .header h1 { margin: 0 0 8px; font-size: 22px; font-weight: 700; letter-spacing: .2px; }
    .sub { margin: 0; color: var(--muted); font-size: 14px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 14px; }
    input[type="file"] {
      padding: 10px 12px; border: 1px dashed var(--border); border-radius: 10px; background: transparent; color: var(--text); cursor: pointer;
    }
    input[type="number"] {
      width: 110px; padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; background: var(--panel-2); color: var(--text); outline: none;
    }
    input[type="number"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--primary) 20%, transparent);
    }
    .btn {
      padding: 10px 14px; border-radius: 10px; border: 1px solid var(--border);
      background: var(--panel-2); color: var(--text); cursor: pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease; user-select: none;
    }
    .btn:hover { background: color-mix(in srgb, var(--panel-2) 80%, var(--text) 3%); }
    .btn:active { transform: translateY(1px); }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }
    .btn.primary {
      background: linear-gradient(180deg, var(--primary), var(--primary-2));
      color: #fff;
      border: 1px solid color-mix(in srgb, var(--primary-2) 80%, black 10%);
      box-shadow: 0 4px 12px color-mix(in srgb, var(--primary) 40%, transparent);
    }
    .btn.primary:hover { filter: brightness(1.05); }
    .btn.ghost { background: transparent; }
    .status { font-size: 14px; color: var(--muted); display: inline-flex; align-items: center; gap: 8px; }
    .status::before { content: ""; width: 8px; height: 8px; border-radius: 50%; background: var(--primary); box-shadow: 0 0 0 6px color-mix(in srgb, var(--primary) 25%, transparent); }
    .panel {
      margin-top: 16px; background: var(--panel); border: 1px solid var(--border);
      border-radius: var(--radius); box-shadow: var(--shadow); padding: 16px;
    }
    .quiz { display: none; }
    .question {
      border: 1px solid var(--border); border-radius: 12px; padding: 14px;
      background: color-mix(in srgb, var(--panel) 85%, var(--panel-2) 15%);
      transition: border-color .15s ease, transform .05s ease, background .2s ease;
    }
    .question + .question { margin-top: 12px; }
    .question:hover { border-color: color-mix(in srgb, var(--primary) 40%, var(--border)); }
    .question h3 { margin: 0 0 10px; font-size: 16px; line-height: 1.4; }
    fieldset { border: none; padding: 0; margin: 0; }
    .options { display: grid; gap: 8px; }
    .choice {
      display: grid; grid-template-columns: 24px 1fr; gap: 10px; align-items: start;
      padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; background: var(--panel-2);
      cursor: pointer; transition: border-color .15s ease, background .15s ease;
    }
    .choice:hover { border-color: color-mix(in srgb, var(--primary) 35%, var(--border)); }
    .choice input { margin-top: 2px; width: 18px; height: 18px; accent-color: var(--primary); }
    .choice span { line-height: 1.35; }
    .footer {
      position: sticky; bottom: 0; background: linear-gradient(180deg, transparent, var(--bg) 40%);
      padding-top: 8px; margin-top: 16px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
    }
    .score {
      font-weight: 700; padding: 6px 10px; border-radius: 999px;
      background: color-mix(in srgb, var(--panel) 80%, var(--panel-2)); border: 1px solid var(--border);
    }
    .hint { font-size: 13px; color: var(--muted); margin-top: 8px; }
    .feedback { margin-top: 8px; font-size: 14px; }
    .chip {
      display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 999px;
      border: 1px solid var(--border); background: var(--panel-2);
    }
    .chip.correct { color: var(--accent); border-color: color-mix(in srgb, var(--accent) 40%, var(--border)); }
    .chip.incorrect { color: var(--danger); border-color: color-mix(in srgb, var(--danger) 40%, var(--border)); }
    .chip.unanswered { color: var(--warning); border-color: color-mix(in srgb, var(--warning) 40%, var(--border)); }
    .explanation {
      margin-top: 8px; padding: 10px 12px; border: 1px dashed var(--border);
      border-radius: 10px; background: color-mix(in srgb, var(--panel) 92%, var(--panel-2)); color: var(--muted);
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.min.js" defer></script>
  <script>
    (function ensurePdfJs() {
      const check = () => {
        if (window.pdfjsLib) return;
        const s = document.createElement('script');
        s.src = 'https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.min.js';
        s.defer = true;
        document.head.appendChild(s);
      };
      setTimeout(check, 120);
    })();
  </script>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Upload a PDF to Generate a Quiz</h1>
      <p class="sub">Moderate-difficulty MCQs created from your document's key concepts and statements.</p>
      <div class="row">
        <input id="pdfInput" type="file" accept="application/pdf" />
        <label for="numQ" class="sub">Questions</label>
        <input id="numQ" type="number" min="3" max="50" value="10" />
        <button id="parseBtn" class="btn primary" disabled>Generate Quiz</button>
        <span id="status" class="status">Select a text-based PDF to begin.</span>
      </div>
    </div>

    <div class="panel quiz" id="quizContainer">
      <div id="questions"></div>
      <div class="footer">
        <button id="submitBtn" class="btn primary">Submit</button>
        <button id="regenerateBtn" class="btn">Regenerate</button>
        <button id="resetBtn" class="btn ghost">Reset</button>
        <span id="score" class="score"></span>
      </div>
      <div class="hint">Tip: Regenerate to get a different mix of cloze, definition, and trueâ€‘about questions.</div>
    </div>
  </div>

  <script>
    const pdfInput = document.getElementById('pdfInput');
    const parseBtn = document.getElementById('parseBtn');
    const statusEl = document.getElementById('status');
    const quizEl = document.getElementById('quizContainer');
    const questionsEl = document.getElementById('questions');
    const submitBtn = document.getElementById('submitBtn');
    const regenerateBtn = document.getElementById('regenerateBtn');
    const resetBtn = document.getElementById('resetBtn');
    const scoreEl = document.getElementById('score');
    const numQInput = document.getElementById('numQ');

    let PDFJS = null;
    let fullDocText = '';
    let latestQuestions = [];

    function initPdfJsOrShowError() {
      PDFJS = window['pdfjsLib'] || null;
      if (!PDFJS) {
        statusEl.textContent = 'Failed to load PDF.js. Check your internet or try another network.';
        parseBtn.disabled = true;
        return false;
      }
      PDFJS.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.worker.min.js';
      return true;
    }

    pdfInput.addEventListener('change', () => {
      parseBtn.disabled = !pdfInput.files?.length;
      statusEl.textContent = pdfInput.files?.length ? 'PDF selected. Click "Generate Quiz".' : 'Select a text-based PDF to begin.';
      scoreEl.textContent = '';
      questionsEl.innerHTML = '';
      quizEl.style.display = 'none';
      fullDocText = '';
      latestQuestions = [];
    });

    parseBtn.addEventListener('click', async () => {
      if (!initPdfJsOrShowError()) return;
      const file = pdfInput.files?.[0];
      if (!file) return;

      statusEl.textContent = 'Reading PDF...';
      parseBtn.disabled = true;

      try {
        const arrayBuffer = await file.arrayBuffer();
        const loadingTask = PDFJS.getDocument({ data: arrayBuffer });
        loadingTask.onPassword = (updatePassword, reason) => {
          const msg = reason === PDFJS.PasswordResponses.NEED_PASSWORD ? 'This PDF is password-protected. Enter password:' : 'Incorrect password. Try again:';
          const pwd = window.prompt(msg, '');
          if (pwd == null) throw new Error('Password required but not provided.');
          updatePassword(pwd);
        };

        const doc = await loadingTask.promise;
        statusEl.textContent = `Extracting text from ${doc.numPages} page(s)...`;

        const pageTexts = [];
        for (let pageNum = 1; pageNum <= doc.numPages; pageNum++) {
          const page = await doc.getPage(pageNum);
          const content = await page.getTextContent();
          const text = content.items.map(item => item.str).filter(Boolean).join(' ');
          pageTexts.push(text);
          statusEl.textContent = `Extracting text... ${pageNum}/${doc.numPages}`;
        }

        fullDocText = normalizeText(pageTexts.join('\n\n'));

        if (wordCount(fullDocText) < 80) {
          statusEl.textContent = 'Document text appears too short. Use a richer, text-based PDF (not scanned).';
          parseBtn.disabled = false;
          return;
        }

        const numQuestions = clamp(parseInt(numQInput.value, 10) || 10, 3, 50);
        latestQuestions = generateModerateQuestions(fullDocText, numQuestions);

        if (latestQuestions.length === 0) {
          statusEl.textContent = 'Could not generate questions. Try reducing question count or a different section of text.';
          parseBtn.disabled = false;
          return;
        }

        renderQuiz(latestQuestions);
        quizEl.style.display = 'block';
        statusEl.textContent = `Generated ${latestQuestions.length} moderate question(s).`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = `Failed to read PDF: ${err?.message || 'Unknown error'}`;
      } finally {
        parseBtn.disabled = false;
      }
    });

    regenerateBtn.addEventListener('click', () => {
      if (!fullDocText) return;
      const numQuestions = clamp(parseInt(numQInput.value, 10) || 10, 3, 50);
      latestQuestions = generateModerateQuestions(fullDocText, numQuestions, { shuffleSeed: Date.now() });
      renderQuiz(latestQuestions);
      scoreEl.textContent = '';
      statusEl.textContent = `Regenerated ${latestQuestions.length} question(s).`;
    });

    submitBtn.addEventListener('click', () => {
      const blocks = [...document.querySelectorAll('.question')];
      let score = 0;
      let unanswered = 0;

      blocks.forEach((block, idx) => {
        block.querySelectorAll('.feedback').forEach(el => el.remove());
        const name = `q${idx}`;
        const selected = document.querySelector(`input[name="${name}"]:checked`);
        const correctIndex = Number(block.dataset.correctIndex);
        const q = latestQuestions[idx];

        const chip = document.createElement('div');
        chip.className = 'feedback';

        if (!selected) {
          unanswered++;
          chip.innerHTML = `<span class="chip unanswered">Unanswered</span> <span class="chip">Correct: ${q.options[correctIndex]}</span>` + (q.explanation ? `<div class="explanation">${q.explanation}</div>` : '');
          block.appendChild(chip);
          return;
        }

        const chosenIndex = Number(selected.value);
        if (chosenIndex === correctIndex) {
          score++;
          chip.innerHTML = `<span class="chip correct">Correct</span>`;
        } else {
          chip.innerHTML = `<span class="chip incorrect">Incorrect</span> <span class="chip">Correct: ${q.options[correctIndex]}</span>` + (q.explanation ? `<div class="explanation">${q.explanation}</div>` : '');
        }
        block.appendChild(chip);
      });

      scoreEl.textContent = `Score: ${score} / ${blocks.length} (Unanswered: ${unanswered})`;
    });

    resetBtn.addEventListener('click', () => {
      document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
      document.querySelectorAll('.feedback').forEach(el => el.remove());
      scoreEl.textContent = '';
    });

    function renderQuiz(questions) {
      questionsEl.innerHTML = '';
      questions.forEach((q, idx) => {
        const container = document.createElement('div');
        container.className = 'question';
        container.dataset.correctIndex = String(q.correctIndex);

        const title = document.createElement('h3');
        title.textContent = q.prompt; // no numbering
        container.appendChild(title);

        const fieldset = document.createElement('fieldset');
        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'options';

        q.options.forEach((opt, optIdx) => {
          const id = `q${idx}_opt${optIdx}`;
          const label = document.createElement('label');
          label.className = 'choice';
          label.setAttribute('for', id);

          const input = document.createElement('input');
          input.type = 'radio';
          input.name = `q${idx}`;
          input.id = id;
          input.value = String(optIdx);

          const text = document.createElement('span');
          text.textContent = opt;

          label.appendChild(input);
          label.appendChild(text);
          optionsDiv.appendChild(label);
        });

        fieldset.appendChild(optionsDiv);
        container.appendChild(fieldset);
        questionsEl.appendChild(container);
      });
      scoreEl.textContent = '';
      document.querySelectorAll('.feedback').forEach(el => el.remove());
    }

    // Helper functions for quiz generation
    function normalizeText(text) {
      return text
        .replace(/\r/g, ' ')
        .replace(/\u00a0/g, ' ')
        .replace(/[ \t]+/g, ' ')
        .replace(/\s+\n/g, '\n')
        .replace(/\n\s+/g, '\n')
        .trim();
    }
    function wordCount(s) { return (s || '').trim().split(/\s+/).filter(Boolean).length; }
    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
    function sentenceSplit(text) {
      return text
        .replace(/([.?!])\s+(?=[A-Z(])/g, '$1|')
        .split('|')
        .map(s => s.replace(/\s+/g, ' ').trim())
        .filter(s => s.length > 0);
    }

    // Simplified quiz generation for demo
    function generateModerateQuestions(text, numQuestions) {
      const sentences = sentenceSplit(text);
      const questions = [];
      
      for (let i = 0; i < Math.min(numQuestions, sentences.length); i++) {
        const sentence = sentences[i];
        if (sentence.length < 20) continue;
        
        // Create a simple fill-in-the-blank question
        const words = sentence.split(' ');
        if (words.length < 5) continue;
        
        const blankIndex = Math.floor(words.length / 2);
        const answer = words[blankIndex];
        const questionText = words.map((word, idx) => idx === blankIndex ? '_____' : word).join(' ');
        
        // Generate distractors
        const distractors = [
          words[blankIndex - 1] || 'option1',
          words[blankIndex + 1] || 'option2', 
          'alternative'
        ].filter(d => d !== answer).slice(0, 3);
        
        const options = [answer, ...distractors].sort(() => Math.random() - 0.5);
        const correctIndex = options.indexOf(answer);
        
        questions.push({
          prompt: questionText,
          options: options,
          correctIndex: correctIndex,
          explanation: `Context: ${sentence}`
        });
      }
      
      return questions.slice(0, numQuestions);
    }
  </script>
</body>
</html>
