<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AttendAI - Student Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .quiz-card {
            background: rgba(255, 255, 255, 0.95);
            color: #1f2937;
        }
        .flashcard {
            perspective: 1000px;
            height: 200px;
        }
        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }
        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .flashcard-back {
            transform: rotateY(180deg);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Navigation -->
    <nav class="glass-effect border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <i class="fas fa-graduation-cap text-2xl text-white mr-3"></i>
                    <h1 class="text-xl font-bold text-white">AttendAI Student</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userInfo" class="text-white/80 text-sm"></span>
                    <button onclick="logout()" class="text-white/80 hover:text-white">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass-effect rounded-xl p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 bg-green-500/20 rounded-lg">
                        <i class="fas fa-check-circle text-green-400 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-white/60 text-sm">Attendance Rate</p>
                        <p id="attendanceRate" class="text-white text-2xl font-bold">0%</p>
                    </div>
                </div>
            </div>
            
            <div class="glass-effect rounded-xl p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-500/20 rounded-lg">
                        <i class="fas fa-book text-blue-400 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-white/60 text-sm">Notes Uploaded</p>
                        <p id="notesCount" class="text-white text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
            
            <div class="glass-effect rounded-xl p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-500/20 rounded-lg">
                        <i class="fas fa-layer-group text-purple-400 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-white/60 text-sm">Flashcards</p>
                        <p id="flashcardsCount" class="text-white text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
            
            <div class="glass-effect rounded-xl p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 bg-yellow-500/20 rounded-lg">
                        <i class="fas fa-question-circle text-yellow-400 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-white/60 text-sm">Quizzes Taken</p>
                        <p id="quizzesCount" class="text-white text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="glass-effect rounded-xl p-6 mb-8">
            <div class="flex space-x-1 mb-6">
                <button onclick="showTab('attendance')" id="tab-attendance" 
                        class="tab-button px-6 py-3 rounded-lg font-medium transition duration-200 bg-white/20 text-white">
                    <i class="fas fa-user-check mr-2"></i>Attendance
                </button>
                <button onclick="showTab('notes')" id="tab-notes" 
                        class="tab-button px-6 py-3 rounded-lg font-medium transition duration-200 text-white/60 hover:text-white">
                    <i class="fas fa-file-upload mr-2"></i>Notes
                </button>
                <button onclick="showTab('flashcards')" id="tab-flashcards" 
                        class="tab-button px-6 py-3 rounded-lg font-medium transition duration-200 text-white/60 hover:text-white">
                    <i class="fas fa-layer-group mr-2"></i>Flashcards
                </button>
                <button onclick="showTab('quiz')" id="tab-quiz" 
                        class="tab-button px-6 py-3 rounded-lg font-medium transition duration-200 text-white/60 hover:text-white">
                    <i class="fas fa-question-circle mr-2"></i>Quiz
                </button>
            </div>

            <!-- Attendance Tab -->
            <div id="content-attendance" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Face Verification -->
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-4">
                            <i class="fas fa-camera mr-2"></i>Face Verification
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-white/90 text-sm font-medium mb-2">Session Code</label>
                                <input type="text" id="sessionCode" 
                                       class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/30"
                                       placeholder="Enter session code">
                            </div>
                            
                            <div class="relative">
                                <video id="studentVideo" autoplay playsinline 
                                       class="w-full h-48 bg-black rounded-lg object-cover"></video>
                                <div id="videoOverlay" class="absolute inset-0 bg-black/50 rounded-lg flex items-center justify-center">
                                    <div class="text-center text-white">
                                        <i class="fas fa-video-slash text-3xl mb-2"></i>
                                        <p>Camera starting...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="verifyAttendance()" 
                                    class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 px-4 rounded-lg font-semibold transition duration-200">
                                <i class="fas fa-check-circle mr-2"></i>Verify & Mark Attendance
                            </button>
                        </div>
                        
                        <div id="verificationStatus" class="mt-4 p-3 rounded-lg bg-white/10 text-white text-sm text-center hidden">
                            <i class="fas fa-info-circle mr-2"></i>
                            <span id="verificationText">Ready to verify</span>
                        </div>
                    </div>

                    <!-- Attendance Stats -->
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-4">
                            <i class="fas fa-chart-bar mr-2"></i>Attendance History
                        </h3>
                        <div class="space-y-4">
                            <div class="bg-white/10 rounded-lg p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-white/80">Last 30 days</span>
                                    <span id="attendance30Days" class="text-white font-semibold">0%</span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-2">
                                    <div id="attendanceBar30" class="bg-emerald-500 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div class="bg-white/10 rounded-lg p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-white/80">Last 7 days</span>
                                    <span id="attendance7Days" class="text-white font-semibold">0%</span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-2">
                                    <div id="attendanceBar7" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <button onclick="loadAttendanceStats()" 
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm">
                                <i class="fas fa-refresh mr-2"></i>Refresh Stats
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes Tab -->
            <div id="content-notes" class="tab-content hidden">
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-semibold text-white mb-4">
                                <i class="fas fa-upload mr-2"></i>Upload Notes
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-white/90 text-sm font-medium mb-2">Class ID (Optional)</label>
                                    <input type="text" id="classId" 
                                           class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/30"
                                           placeholder="Enter class ID">
                                </div>
                                
                                <div>
                                    <label class="block text-white/90 text-sm font-medium mb-2">Select File</label>
                                    <input type="file" id="noteFile" accept=".pdf,.txt" 
                                           class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white file:bg-transparent file:border-0 file:text-white">
                                </div>
                                
                                <button onclick="uploadNote()" 
                                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-4 rounded-lg font-semibold transition duration-200">
                                    <i class="fas fa-upload mr-2"></i>Upload Note
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-lg font-semibold text-white mb-4">
                                <i class="fas fa-list mr-2"></i>My Notes
                            </h3>
                            <div id="notesList" class="space-y-2 max-h-64 overflow-y-auto">
                                <!-- Notes will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Flashcards Tab -->
            <div id="content-flashcards" class="tab-content hidden">
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-white">
                            <i class="fas fa-layer-group mr-2"></i>Flashcards Study Session
                        </h3>
                        <div class="flex space-x-2">
                            <button onclick="generateFlashcards()" 
                                    class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm">
                                <i class="fas fa-magic mr-2"></i>Generate New
                            </button>
                            <button onclick="shuffleFlashcards()" 
                                    class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm">
                                <i class="fas fa-random mr-2"></i>Shuffle
                            </button>
                        </div>
                    </div>
                    
                    <div id="flashcardsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Flashcards will be loaded here -->
                    </div>
                    
                    <div id="noFlashcards" class="text-center text-white/60 py-8">
                        <i class="fas fa-layer-group text-4xl mb-4"></i>
                        <p>No flashcards available. Upload notes and generate flashcards to start studying!</p>
                    </div>
                </div>
            </div>

            <!-- Quiz Tab -->
            <div id="content-quiz" class="tab-content hidden">
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-white">
                            <i class="fas fa-question-circle mr-2"></i>Quiz Challenge
                        </h3>
                        <div class="flex space-x-2">
                            <button onclick="generateQuiz()" 
                                    class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm">
                                <i class="fas fa-magic mr-2"></i>Generate Quiz
                            </button>
                            <button onclick="startQuiz()" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm hidden" 
                                    id="startQuizBtn">
                                <i class="fas fa-play mr-2"></i>Start Quiz
                            </button>
                        </div>
                    </div>
                    
                    <div id="quizContainer" class="hidden">
                        <div class="quiz-card rounded-xl p-6 mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <span id="quizProgress" class="text-gray-600 font-medium">Question 1 of 5</span>
                                <span id="quizScore" class="text-gray-600 font-medium">Score: 0</span>
                            </div>
                            
                            <div class="mb-6">
                                <h4 id="quizQuestion" class="text-xl font-semibold text-gray-800 mb-4"></h4>
                                <div id="quizOptions" class="space-y-3">
                                    <!-- Options will be loaded here -->
                                </div>
                            </div>
                            
                            <div class="flex justify-between">
                                <button onclick="previousQuestion()" 
                                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg" 
                                        id="prevBtn" disabled>
                                    <i class="fas fa-arrow-left mr-2"></i>Previous
                                </button>
                                <button onclick="nextQuestion()" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg" 
                                        id="nextBtn">
                                    Next<i class="fas fa-arrow-right ml-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="quizResults" class="hidden">
                        <div class="quiz-card rounded-xl p-6 text-center">
                            <i class="fas fa-trophy text-4xl text-yellow-500 mb-4"></i>
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">Quiz Complete!</h3>
                            <p id="finalScore" class="text-xl text-gray-600 mb-4"></p>
                            <button onclick="resetQuiz()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg">
                                <i class="fas fa-redo mr-2"></i>Take Another Quiz
                            </button>
                        </div>
                    </div>
                    
                    <div id="noQuiz" class="text-center text-white/60 py-8">
                        <i class="fas fa-question-circle text-4xl mb-4"></i>
                        <p>No quiz available. Upload notes and generate a quiz to test your knowledge!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Container -->
    <div id="messageContainer" class="fixed top-4 right-4 z-50"></div>

    <script>
        let currentTab = 'attendance';
        let mediaStream = null;
        let videoReady = false;
        let currentNoteId = null;
        let flashcards = [];
        let currentFlashcardIndex = 0;
        let quizData = [];
        let currentQuestionIndex = 0;
        let quizScore = 0;
        let userAnswers = [];

        // Initialize dashboard
        window.addEventListener('load', () => {
            loadUserInfo();
            startCamera();
            loadAttendanceStats();
            loadNotes();
            loadFlashcards();
        });

        // Load user info
        function loadUserInfo() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            document.getElementById('userInfo').textContent = `Welcome, ${user.full_name || 'Student'}`;
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('bg-white/20');
                button.classList.add('text-white/60');
            });
            
            // Show selected tab content
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // Add active class to selected tab button
            const activeButton = document.getElementById(`tab-${tabName}`);
            activeButton.classList.add('bg-white/20');
            activeButton.classList.remove('text-white/60');
            
            currentTab = tabName;
        }

        // Show message
        function showMessage(message, type = 'error') {
            const container = document.getElementById('messageContainer');
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
            const icon = type === 'error' ? 'exclamation-triangle' : 'check-circle';
            
            container.innerHTML = `
                <div class="${bgColor} text-white px-6 py-4 rounded-lg shadow-lg flex items-center">
                    <i class="fas fa-${icon} mr-3"></i>
                    ${message}
                </div>
            `;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Camera functions
        async function startCamera() {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.getElementById('studentVideo');
                video.srcObject = mediaStream;
                
                await new Promise(resolve => {
                    if (video.readyState >= 2) return resolve();
                    video.onloadedmetadata = () => resolve();
                });
                
                video.play();
                document.getElementById('videoOverlay').classList.add('hidden');
                videoReady = true;
                
            } catch (error) {
                showMessage('Camera access denied or not available', 'error');
            }
        }

        // Verify attendance
        async function verifyAttendance() {
            const sessionCode = document.getElementById('sessionCode').value;
            
            if (!sessionCode) {
                showMessage('Please enter a session code', 'error');
                return;
            }
            
            if (!videoReady) {
                showMessage('Camera not ready', 'error');
                return;
            }
            
            try {
                const video = document.getElementById('studentVideo');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth || 640;
                canvas.height = video.videoHeight || 480;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
                const fd = new FormData();
                fd.append('user_id', JSON.parse(localStorage.getItem('user')).id);
                fd.append('code', sessionCode);
                fd.append('file', new File([blob], 'frame.jpg', { type: 'image/jpeg' }));
                
                const response = await fetch('/face/verify-and-mark', { method: 'POST', body: fd });
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('âœ… Attendance marked successfully!', 'success');
                    document.getElementById('verificationStatus').classList.remove('hidden');
                    document.getElementById('verificationText').textContent = `Verified with ${(data.similarity || 0).toFixed(2)} similarity`;
                    loadAttendanceStats();
                } else {
                    showMessage(data.detail || 'Verification failed', 'error');
                }
            } catch (error) {
                showMessage('Network error. Please try again.', 'error');
            }
        }

        // Load attendance stats
        async function loadAttendanceStats() {
            try {
                const userId = JSON.parse(localStorage.getItem('user')).id;
                const response = await fetch(`/stats/student/attendance?user_id=${userId}`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('attendanceRate').textContent = `${data.attendance_pct}%`;
                    document.getElementById('attendance30Days').textContent = `${data.attendance_pct}%`;
                    document.getElementById('attendance7Days').textContent = `${data.attendance_pct}%`;
                    document.getElementById('attendanceBar30').style.width = `${data.attendance_pct}%`;
                    document.getElementById('attendanceBar7').style.width = `${data.attendance_pct}%`;
                }
            } catch (error) {
                console.error('Failed to load attendance stats:', error);
            }
        }

        // Upload note
        async function uploadNote() {
            const file = document.getElementById('noteFile').files[0];
            const classId = document.getElementById('classId').value;
            
            if (!file) {
                showMessage('Please select a file', 'error');
                return;
            }
            
            try {
                const fd = new FormData();
                fd.append('user_id', JSON.parse(localStorage.getItem('user')).id);
                if (classId) fd.append('class_id', classId);
                fd.append('file', file);
                
                const response = await fetch('/notes/upload', { method: 'POST', body: fd });
                const data = await response.json();
                
                if (response.ok) {
                    currentNoteId = data.note_id;
                    showMessage('Note uploaded successfully!', 'success');
                    document.getElementById('noteFile').value = '';
                    document.getElementById('classId').value = '';
                    loadNotes();
                } else {
                    showMessage(data.detail || 'Upload failed', 'error');
                }
            } catch (error) {
                showMessage('Network error. Please try again.', 'error');
            }
        }

        // Load notes
        async function loadNotes() {
            // This would typically load notes from the backend
            document.getElementById('notesList').innerHTML = `
                <div class="text-white/60 text-center py-4">
                    <i class="fas fa-file-alt text-2xl mb-2"></i>
                    <p>No notes uploaded yet</p>
                </div>
            `;
        }

        // Generate flashcards
        async function generateFlashcards() {
            if (!currentNoteId) {
                showMessage('Please upload a note first', 'error');
                return;
            }
            
            try {
                const fd = new FormData();
                fd.append('note_id', currentNoteId);
                fd.append('max_cards', '12');
                
                const response = await fetch('/notes/flashcards/generate', { method: 'POST', body: fd });
                const data = await response.json();
                
                if (response.ok) {
                    showMessage(`Generated ${data.created} flashcards!`, 'success');
                    loadFlashcards();
                } else {
                    showMessage(data.detail || 'Generation failed', 'error');
                }
            } catch (error) {
                showMessage('Network error. Please try again.', 'error');
            }
        }

        // Load flashcards
        async function loadFlashcards() {
            if (!currentNoteId) return;
            
            try {
                const response = await fetch(`/notes/flashcards/list?note_id=${currentNoteId}`);
                const data = await response.json();
                
                flashcards = data;
                currentFlashcardIndex = 0;
                renderFlashcards();
                
                document.getElementById('flashcardsCount').textContent = flashcards.length;
            } catch (error) {
                console.error('Failed to load flashcards:', error);
            }
        }

        // Render flashcards
        function renderFlashcards() {
            const container = document.getElementById('flashcardsContainer');
            const noFlashcards = document.getElementById('noFlashcards');
            
            if (flashcards.length === 0) {
                container.innerHTML = '';
                noFlashcards.classList.remove('hidden');
                return;
            }
            
            noFlashcards.classList.add('hidden');
            container.innerHTML = flashcards.map((card, index) => `
                <div class="flashcard" onclick="flipCard(${index})">
                    <div class="flashcard-inner">
                        <div class="flashcard-front bg-blue-500 text-white">
                            <div>
                                <h4 class="font-semibold mb-2">Front</h4>
                                <p>${card.front}</p>
                            </div>
                        </div>
                        <div class="flashcard-back bg-green-500 text-white">
                            <div>
                                <h4 class="font-semibold mb-2">Back</h4>
                                <p>${card.back}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Flip card
        function flipCard(index) {
            const card = document.querySelectorAll('.flashcard')[index];
            card.classList.toggle('flipped');
        }

        // Shuffle flashcards
        function shuffleFlashcards() {
            flashcards = flashcards.sort(() => Math.random() - 0.5);
            renderFlashcards();
            showMessage('Flashcards shuffled!', 'success');
        }

        // Generate quiz
        async function generateQuiz() {
            if (!currentNoteId) {
                showMessage('Please upload a note first', 'error');
                return;
            }
            
            try {
                const fd = new FormData();
                fd.append('note_id', currentNoteId);
                fd.append('num_questions', '5');
                
                const response = await fetch('/notes/quiz/generate', { method: 'POST', body: fd });
                const data = await response.json();
                
                if (response.ok) {
                    quizData = data.questions;
                    document.getElementById('startQuizBtn').classList.remove('hidden');
                    showMessage(`Generated ${quizData.length} quiz questions!`, 'success');
                } else {
                    showMessage(data.detail || 'Generation failed', 'error');
                }
            } catch (error) {
                showMessage('Network error. Please try again.', 'error');
            }
        }

        // Start quiz
        function startQuiz() {
            if (quizData.length === 0) {
                showMessage('No quiz questions available', 'error');
                return;
            }
            
            currentQuestionIndex = 0;
            quizScore = 0;
            userAnswers = [];
            
            document.getElementById('quizContainer').classList.remove('hidden');
            document.getElementById('quizResults').classList.add('hidden');
            document.getElementById('noQuiz').classList.add('hidden');
            
            showQuestion();
        }

        // Show question
        function showQuestion() {
            const question = quizData[currentQuestionIndex];
            document.getElementById('quizProgress').textContent = `Question ${currentQuestionIndex + 1} of ${quizData.length}`;
            document.getElementById('quizScore').textContent = `Score: ${quizScore}`;
            document.getElementById('quizQuestion').textContent = question.question;
            
            const optionsContainer = document.getElementById('quizOptions');
            optionsContainer.innerHTML = question.options.map((option, index) => `
                <label class="flex items-center p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200">
                    <input type="radio" name="quizAnswer" value="${option}" class="mr-3">
                    <span>${String.fromCharCode(65 + index)}. ${option}</span>
                </label>
            `).join('');
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').textContent = currentQuestionIndex === quizData.length - 1 ? 'Finish' : 'Next';
        }

        // Next question
        function nextQuestion() {
            const selectedAnswer = document.querySelector('input[name="quizAnswer"]:checked');
            if (!selectedAnswer) {
                showMessage('Please select an answer', 'error');
                return;
            }
            
            userAnswers[currentQuestionIndex] = selectedAnswer.value;
            
            if (selectedAnswer.value === quizData[currentQuestionIndex].answer) {
                quizScore++;
            }
            
            if (currentQuestionIndex === quizData.length - 1) {
                finishQuiz();
            } else {
                currentQuestionIndex++;
                showQuestion();
            }
        }

        // Previous question
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion();
            }
        }

        // Finish quiz
        function finishQuiz() {
            document.getElementById('quizContainer').classList.add('hidden');
            document.getElementById('quizResults').classList.remove('hidden');
            
            const percentage = Math.round((quizScore / quizData.length) * 100);
            document.getElementById('finalScore').textContent = `You scored ${quizScore}/${quizData.length} (${percentage}%)`;
            
            document.getElementById('quizzesCount').textContent = parseInt(document.getElementById('quizzesCount').textContent) + 1;
        }

        // Reset quiz
        function resetQuiz() {
            document.getElementById('quizContainer').classList.add('hidden');
            document.getElementById('quizResults').classList.add('hidden');
            document.getElementById('startQuizBtn').classList.add('hidden');
        }

        // Logout
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }
    </script>
</body>
</html>
