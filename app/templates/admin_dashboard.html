<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AttendAI - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Navigation -->
    <nav class="glass-effect border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <i class="fas fa-graduation-cap text-2xl text-white mr-3"></i>
                    <h1 class="text-xl font-bold text-white">AttendAI Admin</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userInfo" class="text-white/80 text-sm"></span>
                    <button onclick="logout()" class="text-white/80 hover:text-white">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass-effect rounded-xl p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-500/20 rounded-lg">
                        <i class="fas fa-users text-blue-400 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-white/60 text-sm">Total Students</p>
                        <p id="totalStudents" class="text-white text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
            
            <div class="glass-effect rounded-xl p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 bg-green-500/20 rounded-lg">
                        <i class="fas fa-chalkboard-teacher text-green-400 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-white/60 text-sm">Active Sessions</p>
                        <p id="activeSessions" class="text-white text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
            
            <div class="glass-effect rounded-xl p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 bg-yellow-500/20 rounded-lg">
                        <i class="fas fa-check-circle text-yellow-400 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-white/60 text-sm">Attendance Today</p>
                        <p id="attendanceToday" class="text-white text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
            
            <div class="glass-effect rounded-xl p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-500/20 rounded-lg">
                        <i class="fas fa-book text-purple-400 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-white/60 text-sm">Total Classes</p>
                        <p id="totalClasses" class="text-white text-2xl font-bold">1</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Session Management -->
            <div class="glass-effect rounded-xl p-6">
                <h2 class="text-xl font-semibold text-white mb-6">
                    <i class="fas fa-play-circle mr-2"></i>Session Management
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-white/90 text-sm font-medium mb-2">Session Code</label>
                        <input type="text" id="sessionCode" 
                               class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/30"
                               placeholder="Enter session code (e.g., ABC123)">
                    </div>
                    
                    <div>
                        <label class="block text-white/90 text-sm font-medium mb-2">Subject (Optional)</label>
                        <input type="text" id="subject" 
                               class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/30"
                               placeholder="Enter subject name">
                    </div>
                    
                    <button onclick="startSession()" 
                            class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 px-4 rounded-lg font-semibold transition duration-200">
                        <i class="fas fa-play mr-2"></i>Start Session
                    </button>
                </div>
                
                <div id="sessionStatus" class="mt-4 p-4 rounded-lg hidden">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white font-medium">Session Active</p>
                            <p id="sessionInfo" class="text-white/60 text-sm"></p>
                        </div>
                        <button onclick="stopSession()" 
                                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-stop mr-1"></i>Stop
                        </button>
                    </div>
                </div>
            </div>

            <!-- Camera Feed -->
            <div class="glass-effect rounded-xl p-6">
                <h2 class="text-xl font-semibold text-white mb-6">
                    <i class="fas fa-video mr-2"></i>Live Camera Feed
                </h2>
                
                <div class="relative">
                    <video id="adminVideo" autoplay playsinline 
                           class="w-full h-64 bg-black rounded-lg object-cover"></video>
                    <div id="cameraOverlay" class="absolute inset-0 bg-black/50 rounded-lg flex items-center justify-center hidden">
                        <div class="text-center text-white">
                            <i class="fas fa-video-slash text-4xl mb-2"></i>
                            <p>Camera not started</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 flex justify-center space-x-4">
                    <button id="startCameraBtn" onclick="startCamera()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-play mr-2"></i>Start Camera
                    </button>
                    <button id="stopCameraBtn" onclick="stopCamera()" 
                            class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg hidden">
                        <i class="fas fa-stop mr-2"></i>Stop Camera
                    </button>
                </div>
                
                <div id="cameraStatus" class="mt-4 p-3 rounded-lg bg-white/10 text-white text-sm text-center">
                    <i class="fas fa-info-circle mr-2"></i>
                    <span id="cameraStatusText">Camera ready to start</span>
                </div>
            </div>
        </div>

        <!-- Student Management -->
        <div class="mt-8">
            <div class="glass-effect rounded-xl p-6">
                <h2 class="text-xl font-semibold text-white mb-6">
                    <i class="fas fa-user-graduate mr-2"></i>Student Management
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-medium text-white mb-4">Add New Student</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-white/90 text-sm font-medium mb-2">Full Name</label>
                                <input type="text" id="studentName" 
                                       class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/30"
                                       placeholder="Enter student name">
                            </div>
                            
                            <div>
                                <label class="block text-white/90 text-sm font-medium mb-2">Email</label>
                                <input type="email" id="studentEmail" 
                                       class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/30"
                                       placeholder="Enter student email">
                            </div>
                            
                            <button onclick="addStudent()" 
                                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-4 rounded-lg font-semibold transition duration-200">
                                <i class="fas fa-user-plus mr-2"></i>Add Student
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-medium text-white mb-4">Student List</h3>
                        <div id="studentList" class="space-y-2 max-h-64 overflow-y-auto">
                            <!-- Students will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Container -->
    <div id="messageContainer" class="fixed top-4 right-4 z-50"></div>

    <script>
        let adminStream = null;
        let adminLoop = null;
        let currentSessionCode = null;

        // Initialize dashboard
        window.addEventListener('load', () => {
            loadUserInfo();
            loadStudents();
            loadStats();
        });

        // Load user info
        function loadUserInfo() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            document.getElementById('userInfo').textContent = `Welcome, ${user.full_name || 'Admin'}`;
        }

        // Show message
        function showMessage(message, type = 'error') {
            const container = document.getElementById('messageContainer');
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
            const icon = type === 'error' ? 'exclamation-triangle' : 'check-circle';
            
            container.innerHTML = `
                <div class="${bgColor} text-white px-6 py-4 rounded-lg shadow-lg flex items-center">
                    <i class="fas fa-${icon} mr-3"></i>
                    ${message}
                </div>
            `;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Start session
        async function startSession() {
            const code = document.getElementById('sessionCode').value;
            const subject = document.getElementById('subject').value;
            
            if (!code) {
                showMessage('Please enter a session code', 'error');
                return;
            }
            
            try {
                // Create or get the AUTO class
                await fetch('/admin/classes?name=Auto Class&code=AUTO&created_by_user_id=1', { method: 'POST' });
                
                // Start session
                const response = await fetch(`/admin/sessions/start?class_code=AUTO&code=${encodeURIComponent(code)}&subject=${encodeURIComponent(subject)}`, { method: 'POST' });
                
                if (response.ok) {
                    currentSessionCode = code;
                    document.getElementById('sessionStatus').classList.remove('hidden');
                    document.getElementById('sessionInfo').textContent = `Session: ${code}${subject ? ` - ${subject}` : ''}`;
                    showMessage('Session started successfully!', 'success');
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to start session', 'error');
                }
            } catch (error) {
                showMessage('Network error. Please try again.', 'error');
            }
        }

        // Stop session
        async function stopSession() {
            if (!currentSessionCode) return;
            
            try {
                const response = await fetch(`/admin/sessions/stop?code=${encodeURIComponent(currentSessionCode)}`, { method: 'POST' });
                
                if (response.ok) {
                    document.getElementById('sessionStatus').classList.add('hidden');
                    currentSessionCode = null;
                    showMessage('Session stopped successfully!', 'success');
                } else {
                    showMessage('Failed to stop session', 'error');
                }
            } catch (error) {
                showMessage('Network error. Please try again.', 'error');
            }
        }

        // Start camera
        async function startCamera() {
            try {
                adminStream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.getElementById('adminVideo');
                video.srcObject = adminStream;
                
                await new Promise(resolve => {
                    if (video.readyState >= 2) return resolve();
                    video.onloadedmetadata = () => resolve();
                });
                
                video.play();
                document.getElementById('cameraOverlay').classList.add('hidden');
                document.getElementById('startCameraBtn').classList.add('hidden');
                document.getElementById('stopCameraBtn').classList.remove('hidden');
                document.getElementById('cameraStatusText').textContent = 'Camera active - Auto-identifying students';
                
                // Start auto-identify loop
                adminLoop = setInterval(sendFrame, 2000);
                
            } catch (error) {
                showMessage('Camera access denied or not available', 'error');
            }
        }

        // Stop camera
        function stopCamera() {
            if (adminLoop) {
                clearInterval(adminLoop);
                adminLoop = null;
            }
            
            if (adminStream) {
                adminStream.getTracks().forEach(track => track.stop());
                adminStream = null;
            }
            
            document.getElementById('cameraOverlay').classList.remove('hidden');
            document.getElementById('startCameraBtn').classList.remove('hidden');
            document.getElementById('stopCameraBtn').classList.add('hidden');
            document.getElementById('cameraStatusText').textContent = 'Camera stopped';
        }

        // Send frame for auto-identification
        async function sendFrame() {
            if (!currentSessionCode) return;
            
            try {
                const video = document.getElementById('adminVideo');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth || 640;
                canvas.height = video.videoHeight || 480;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
                const fd = new FormData();
                fd.append('code', currentSessionCode);
                fd.append('file', new File([blob], 'frame.jpg', { type: 'image/jpeg' }));
                
                const headers = {};
                const adminKey = localStorage.getItem('ADMIN_KEY') || '';
                if (adminKey) headers['X-Admin-Key'] = adminKey;
                
                const response = await fetch('/face/auto-identify-and-mark', { method: 'POST', body: fd, headers });
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('cameraStatusText').textContent = `Marked user ${data.user_id} (similarity: ${(data.similarity || 0).toFixed(2)})`;
                }
            } catch (error) {
                console.error('Frame processing error:', error);
            }
        }

        // Add student
        async function addStudent() {
            const name = document.getElementById('studentName').value;
            const email = document.getElementById('studentEmail').value;
            
            if (!name || !email) {
                showMessage('Please fill in all fields', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/admin/students/create?email=${encodeURIComponent(email)}&full_name=${encodeURIComponent(name)}`, { method: 'POST' });
                
                if (response.ok) {
                    showMessage('Student added successfully!', 'success');
                    document.getElementById('studentName').value = '';
                    document.getElementById('studentEmail').value = '';
                    loadStudents();
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Failed to add student', 'error');
                }
            } catch (error) {
                showMessage('Network error. Please try again.', 'error');
            }
        }

        // Load students
        async function loadStudents() {
            try {
                const response = await fetch('/admin/students/list');
                const students = await response.json();
                
                const container = document.getElementById('studentList');
                container.innerHTML = students.map(student => `
                    <div class="flex items-center justify-between p-3 bg-white/10 rounded-lg">
                        <div>
                            <p class="text-white font-medium">${student.full_name}</p>
                            <p class="text-white/60 text-sm">${student.email}</p>
                        </div>
                        <span class="text-white/60 text-sm">ID: ${student.id}</span>
                    </div>
                `).join('');
                
                document.getElementById('totalStudents').textContent = students.length;
            } catch (error) {
                console.error('Failed to load students:', error);
            }
        }

        // Load stats
        async function loadStats() {
            // This would typically load real stats from the backend
            document.getElementById('activeSessions').textContent = currentSessionCode ? '1' : '0';
            document.getElementById('attendanceToday').textContent = '0'; // Would be calculated from attendance records
        }

        // Logout
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }
    </script>
</body>
</html>
